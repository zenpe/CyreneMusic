# Windows 自动更新 - UAC 权限提升

## 📋 问题描述

当 Cyrene Music 安装在系统保护的目录下（如 `C:\Program Files` 或 `C:\Program Files (x86)`）时，自动更新需要管理员权限才能替换文件。

### 之前的行为
- ❌ 更新时提示：权限不足（Access Denied）
- ❌ 文件复制失败
- ❌ 需要手动以管理员身份运行程序才能更新
- ❌ 用户体验不佳

## ✅ 解决方案

### 自动请求管理员权限

更新器批处理文件现在会自动检测是否需要管理员权限，并通过 Windows UAC（用户账户控制）请求提升权限。

### 工作流程

```
┌─────────────────────────────────┐
│  用户点击"更新"按钮              │
└────────────┬────────────────────┘
             │
             ▼
┌─────────────────────────────────┐
│  下载并解压更新包                │
└────────────┬────────────────────┘
             │
             ▼
┌─────────────────────────────────┐
│  启动更新器批处理文件            │
└────────────┬────────────────────┘
             │
             ▼
┌─────────────────────────────────┐
│  批处理：检查当前权限            │
│  net session >nul 2>&1          │
└────────────┬────────────────────┘
             │
        ┌────┴────┐
        │         │
   已有管理员    普通权限
        │         │
        │         ▼
        │    ┌─────────────────────────────┐
        │    │ 弹出 UAC 提权对话框          │
        │    │ "是否允许此应用进行更改？"    │
        │    └─────────┬───────────────────┘
        │              │
        │         ┌────┴────┐
        │         │         │
        │     用户确认   用户拒绝
        │         │         │
        │         │         ▼
        │         │    更新失败
        │         │
        └─────┬───┘
              │
              ▼
┌─────────────────────────────────┐
│  以管理员权限运行更新器          │
└────────────┬────────────────────┘
             │
             ▼
┌─────────────────────────────────┐
│  主程序退出                      │
└────────────┬────────────────────┘
             │
             ▼
┌─────────────────────────────────┐
│  更新器等待主程序完全退出        │
└────────────┬────────────────────┘
             │
             ▼
┌─────────────────────────────────┐
│  复制新文件到安装目录            │
│  ✅ 有权限写入系统目录           │
└────────────┬────────────────────┘
             │
             ▼
┌─────────────────────────────────┐
│  清理临时文件                    │
└────────────┬────────────────────┘
             │
             ▼
┌─────────────────────────────────┐
│  重新启动应用                    │
│  ✅ 更新成功                     │
└─────────────────────────────────┘
```

## 🔧 技术实现

### 批处理文件中的 UAC 检测逻辑

```batch
@echo off
:: Check for administrator privileges
net session >nul 2>&1
if %errorLevel% == 0 (
    :: Already running as administrator
    goto :RunUpdater
) else (
    :: Request administrator privileges
    echo Requesting administrator privileges...
    powershell -Command "Start-Process -FilePath '%~f0' -Verb RunAs"
    exit /b
)

:RunUpdater
:: Continue with update process...
```

### 工作原理

1. **权限检测**：`net session` 命令需要管理员权限才能执行成功
   - 返回码 `0`：已有管理员权限
   - 返回码非 `0`：普通权限

2. **权限提升**：使用 PowerShell 的 `Start-Process -Verb RunAs`
   - 触发 Windows UAC 对话框
   - 以管理员权限重新启动批处理文件
   - 原批处理进程退出

3. **更新执行**：重新启动后以管理员权限运行
   - 可以写入系统保护的目录
   - 可以替换正在使用的文件
   - 更新成功完成

## 🎯 用户体验

### 标准流程
1. 用户在应用内点击"更新"按钮
2. 应用下载更新包并准备安装
3. **弹出 Windows UAC 对话框**
4. 用户点击"是"确认授权
5. 更新自动完成并重启应用

### UAC 对话框示例

```
┌───────────────────────────────────────────┐
│  用户账户控制                              │
├───────────────────────────────────────────┤
│                                            │
│  你要允许此应用对你的设备进行更改吗？      │
│                                            │
│  start_updater.bat                        │
│  已验证的发布者：未知                      │
│  文件来源：此计算机上的硬盘                │
│                                            │
│  显示详细信息                              │
│                                            │
│          [ 是(Y) ]      [ 否(N) ]         │
└───────────────────────────────────────────┘
```

## 📊 兼容性

### 支持的 Windows 版本
- ✅ Windows Vista 及更高版本（支持 UAC）
- ✅ Windows 7
- ✅ Windows 8/8.1
- ✅ Windows 10
- ✅ Windows 11

### 安装位置
无论安装在哪里都能正常工作：
- ✅ `C:\Program Files\Cyrene Music\`
- ✅ `C:\Program Files (x86)\Cyrene Music\`
- ✅ `C:\Users\用户名\AppData\Local\Cyrene Music\`
- ✅ 任何自定义目录

## 🔒 安全性

### UAC 的作用
1. **防止未授权的系统修改**：确保用户知道并同意程序对系统的修改
2. **可见性**：用户可以看到哪个程序请求权限
3. **可控性**：用户可以拒绝权限请求

### 为什么安全
1. 更新器只在用户主动点击"更新"后运行
2. UAC 对话框显示文件信息，用户可以确认
3. 更新器脚本是内嵌在应用中的，不会被恶意篡改
4. 更新完成后自动退出，不会保留管理员权限

## 💡 常见问题

### Q: 为什么需要管理员权限？
A: 当应用安装在 `C:\Program Files` 等系统保护目录时，Windows 不允许普通程序修改这些目录中的文件，需要管理员权限。

### Q: 能否在安装时就避免这个问题？
A: 可以将应用安装到用户目录（如 `%LocalAppData%`），但很多用户习惯安装到 `Program Files`。我们的解决方案支持任何安装位置。

### Q: 如果用户拒绝授权会怎样？
A: 更新会失败，应用保持当前版本。用户可以稍后重试，或者手动以管理员身份运行应用再更新。

### Q: 每次更新都需要授权吗？
A: 是的，出于安全考虑，Windows UAC 每次都会请求确认。这是 Windows 的标准安全机制。

### Q: 会不会影响已经安装在非系统目录的用户？
A: 不会。如果安装在用户目录或其他非保护目录，权限检测会通过，不会弹出 UAC 对话框，更新会静默完成。

## 🧪 测试

### 测试场景 1：安装在 Program Files
```powershell
# 安装位置
C:\Program Files (x86)\Cyrene Music\

# 预期行为
1. 点击更新
2. 下载完成
3. 弹出 UAC 对话框
4. 点击"是"
5. 更新成功并重启
```

### 测试场景 2：安装在用户目录
```powershell
# 安装位置
C:\Users\用户名\AppData\Local\Cyrene Music\

# 预期行为
1. 点击更新
2. 下载完成
3. 不弹出 UAC（不需要提权）
4. 更新成功并重启
```

### 测试场景 3：用户拒绝授权
```powershell
# 操作
1. 点击更新
2. 下载完成
3. UAC 对话框出现
4. 点击"否"

# 预期结果
- 批处理退出
- 更新失败
- 应用显示错误信息
- 临时文件保留（可重试）
```

## 📝 代码位置

修改的文件：
- `lib/services/auto_update_service.dart` - 生成带 UAC 提权逻辑的批处理文件

相关文件：
- `windows/runner/updater.ps1` - PowerShell 更新器脚本
- `docs/WINDOWS_AUTO_UPDATE_FIX.md` - Windows 更新器实现文档
- `docs/WINDOWS_AUTO_UPDATE_FINAL.md` - Windows 更新器完整方案

## 🎉 总结

通过添加自动 UAC 提权逻辑，我们实现了：

- ✅ **无缝更新体验**：无论安装在哪里都能正常更新
- ✅ **自动权限管理**：需要时自动请求，不需要时静默执行
- ✅ **安全可靠**：遵循 Windows 安全最佳实践
- ✅ **用户友好**：清晰的授权提示，用户完全可控
- ✅ **向后兼容**：不影响现有用户的更新流程

现在，即使应用安装在 `C:\Program Files (x86)`，用户也可以一键完成自动更新，无需手动以管理员身份运行应用！🚀

